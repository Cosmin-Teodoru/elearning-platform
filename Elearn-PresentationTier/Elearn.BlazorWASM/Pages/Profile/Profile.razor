@page "/Profile"
@using Elearn.Shared.Models
@using Microsoft.AspNetCore.Components
@using Elearn.Shared.Dtos
@using Elearn.HttpClients.Service
@using System.Security.Claims
@using System.Net.Mime
@using Elearn.BlazorWASM.Pages.Profile.UIComponents
@inject ILectureService _lectureService
@inject IQuestionService _questionService
@inject IUserService _userService
@inject NavigationManager NavMgr 


<AuthorizeView>
    <NotAuthorized>
        <div class="d-flex align-center justify-center">
            <h3>Please log in to view your user profile</h3>
        </div>
        <div>
            <MudCardActions Class="d-flex justify-center">
                <MudButton Class="mx-2" OnClick="() => OpenLoginView()" Variant="Variant.Filled" Color="Color.Success">
                    <img src="img/Login.png"/>
                </MudButton>
            </MudCardActions>
        </div>

    </NotAuthorized>
    <Authorized Context="Auth">
   

        <div class="page-background-class align-center justify-center">
            <MudCard Class="mx-auto pa-6 mt-12" Style="width: 500px;">
                <h3 class=" d-flex justify-center">Hello, @CurrentUser?.Name</h3>
                <div class="form-group d-flex justify-center">
                    <label>User Id : @CurrentUser?.Id</label>
                </div>
                <div class="form-group d-flex justify-center">
                    <label>Username : @CurrentUser?.Username</label>
                </div>
                <div class="form-group d-flex justify-center">
                    <label>Current email : @CurrentUser?.Email</label>
                </div>
                <div class="form-group d-flex justify-center">
                    <label> Role : @CurrentUser?.Role</label>
                </div>

                <MudCard>
                    <MudCardContent>
                        <MudImage Class="card-img" Src="@Dto.Image" ObjectFit="ObjectFit.Contain" Height="200"></MudImage>
                    </MudCardContent>
                    <MudCardActions class="form-control-file">
                        <label for="image">Image</label>
                        <InputFile OnChange="OnFileChange"></InputFile>
                    </MudCardActions>
                    <MudCardActions>
                        <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="@(UpdateImage)">Save</MudButton>
                    </MudCardActions>
                </MudCard>


            </MudCard>
        </div>
        <br/>

        <hr/>
        <br/>
        <br/>
        <div class="page-background-class align-center justify-center">
            <div class="allLectures">
                <h2>All Lectures</h2>
                   
                   @if (CurrentUser == null)
                     {
                         <span> No lectures found</span>
                     }
                     else
                     {
                         <MudGrid Class="my-6" Justify="Justify.Center">
                             @foreach (var lectures in _lectureToShow)
                             {
                                 <MudItem xs="12" sm="9" md="7">
                                     <History Lecture="@lectures"></History>
                                 </MudItem>
                                 
                             }
                         </MudGrid>
                     }
                   

                <hr/>
                <br/>
                <br/>

            </div>
            <div class="allLectures">
                <h2>Upvoted Lectures</h2>
                @if (CurrentUser == null)
                {
                    <span> No lectures found</span>
                }
                else
                {
                    <MudGrid Class="my-6" Justify="Justify.Center">
                        @foreach (var lectures in _upvotedLectureToShow)
                        {
                            <MudItem xs="12" sm="9" md="7">
                                <History Lecture="@lectures"></History>
                            </MudItem>
                                                 
                        }
                    </MudGrid>
                }
                <hr/>
                <br/>
                <br/>
            </div>
            
            <div class="allQuestions">
                <h2>All Questions</h2>
                 @if (CurrentUser == null)
                                                    {
                                                        <span> No questions found</span>
                                                    }
                                                    else
                                                    {
                                                        <MudGrid Class="my-6" Justify="Justify.Center">
                                                            @foreach (var lectures in _questionToShow)
                                                            {
                                                                <MudItem xs="12" sm="9" md="7">
                                                                    <QuestionHistory QuestionDto="@lectures"></QuestionHistory>
                                                                </MudItem>
                                                                
                                                            }
                                                        </MudGrid>
                                                    }
            </div>
        </div>
    </Authorized>

</AuthorizeView>

@code {

    [CascadingParameter]
    public Task<AuthenticationState> AuthState { get; set; } = null!;

    private IEnumerable<Claim>? userClaims;
    private string? username;
    private bool isLoggedIn;
    private List<LectureDto?> _lectureToShow = new List<LectureDto?>();
  //  private List<LectureDto> _lectureToDto;
    private List<LectureDto?> _upvotedLectureToShow = new List<LectureDto?>();
    private List<QuestionDto?> _questionToShow = new List<QuestionDto?>();
    private bool _hidePosition;
    private bool _loading;
    public UserDto? CurrentUser;
    public UpdateUserDto Dto = new();

    private void OpenLoginView()
    {
        NavMgr.NavigateTo($"/LoginUI");
    }

    protected override async Task OnInitializedAsync()
    {
        if (await InitUpdateUser()) return;
        await InitHistory();
        Console.WriteLine("sdadasdassdas");
       
    }

    private async Task<bool> InitUpdateUser()
    {
        AuthenticationState authState = await AuthState;
        ClaimsPrincipal user = authState.User;
        isLoggedIn = user.Identity != null;
        if (!isLoggedIn) return true;
        userClaims = user.Claims;
        username = user.Identity!.Name;
        CurrentUser = await _userService.GetUserByUsernameAsync(username);
        CreateDto(CurrentUser);
        return false;
    }

    private void CreateDto(UserDto userDto)
    {
        Dto = new UpdateUserDto
        {
            Name = userDto.Name,
            Password = userDto.Password,
            Email = userDto.Email,
            Image = userDto.Image,
            Approved = userDto.Approved
        };
    }

    private async Task InitHistory()
    {
        try
        {
            Console.WriteLine("Ion Baton");
            await GetLectureByTeacherId();
            await GetUpvotedLecureByUserId();
            await GetQuestionByUserId();
            Console.WriteLine("asdasdasdas");
        }
        catch (Exception e)
        {
            Console.WriteLine("Nu merge");
            Console.WriteLine(e.Message);
        }
    }


    async Task OnFileChange(InputFileChangeEventArgs e)
    {
        var format = "image/png";
        var resizedImage = await e.File.RequestImageFileAsync(format, 500, 500);
        var buffer = new byte[resizedImage.Size];
        await resizedImage.OpenReadStream().ReadAsync(buffer);
        var imageData = $"data:{format};base64,{Convert.ToBase64String(buffer)}";
        Console.WriteLine($"{imageData} is here");
        Dto.Image = imageData;
    }

    private async Task UpdateImage()
    {
        Console.WriteLine(Dto);
        await _userService.UpdateUserAsync(Dto);
        NavMgr.NavigateTo($"/Profile", true);
    }


    private async Task GetLectureByTeacherId()
    { 
      //  CurrentUser = await _userService.GetUserByNameAsync(username);
        Console.WriteLine(CurrentUser);
        if (CurrentUser is not null)
        {
            _lectureToShow = await _lectureService.GetLectureByTeacherIdAsync(CurrentUser.Id);
            Console.WriteLine(_lectureToShow);
        }
     //  _lectureToShow = await _lectureService.GetLectureByTeacherIdAsync(CurrentUser.Id);
    }

    private async Task GetUpvotedLecureByUserId()
    {
        Console.WriteLine(CurrentUser);
        if (CurrentUser is not null)
        {
            _upvotedLectureToShow = await _lectureService.GetUpvotedLectureByUserIdAsync(CurrentUser.Id);
            Console.WriteLine(_lectureToShow);
        }    }

    private async Task GetQuestionByUserId()
    {
        Console.WriteLine(CurrentUser);
        if (CurrentUser is not null)
        {
            _questionToShow = await _questionService.GetQuestionByUserIdAsync(CurrentUser.Id);
            Console.WriteLine(_lectureToShow);
        }     }

}