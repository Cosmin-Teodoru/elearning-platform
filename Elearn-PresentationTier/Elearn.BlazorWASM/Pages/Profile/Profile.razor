@page "/Profile"
@using Elearn.Shared.Models
@using Microsoft.AspNetCore.Components
@using Elearn.Shared.Dtos
@using Elearn.HttpClients.Service
@using System.Security.Claims
@inject ILectureService _lectureService
@inject IQuestionService _questionService
@inject IUserService _userService
@inject NavigationManager NavMgr 

@* *@
@* <div class="container emp-profile"> *@
@* <form method="post"> *@
@*         <div class="row"> *@
@*             <div class="col-md-6"> *@
@*             </div> *@
@*             <AuthorizeView> *@
@*                 <Authorized> *@
@*                     @if (context.User.Identity!.Name!.Equals(User.Username)) { *@
@*                         <div class="col-md-2"> *@
@*                             <input type="submit" class="profile-edit-btn" name="btnAddMore" value="Edit Profile"/> *@
@*                         </div> *@
@*                     } *@
@*                 </Authorized> *@
@*             </AuthorizeView> *@
@* *@
@* *@
@* *@
@*         </div> *@
@*         <div class="row"> *@
@*             <div class="col-md-8"> *@
@* *@
@*                 <div class="row"> *@
@*                     <div class="col-md-6"> *@
@*                         <label>User name </label> *@
@*                     </div> *@
@*                     <div class="col-md-6"> *@
@*                         <p>@User.Username</p> *@
@*                     </div> *@
@*                 </div> *@
@*                 <div class="row"> *@
@*                     <div class="col-md-6"> *@
@*                         <label>Name</label> *@
@*                     </div> *@
@*                     <div class="col-md-6"> *@
@*                         <p>@User.Name</p> *@
@*                     </div> *@
@*                 </div> *@
@*                 <div class="row"> *@
@*                     <div class="col-md-6"> *@
@*                         <label>Email</label> *@
@*                     </div> *@
@*                     <div class="col-md-6"> *@
@*                         <p>@User.Email</p> *@
@*                     </div> *@
@*                 </div> *@
@*                 <div class="row"> *@
@*                                     <div class="col-md-6"> *@
@*                                         <label>Role</label> *@
@*                                     </div> *@
@*                                     <div class="col-md-6"> *@
@*                                         <p>@User.Role</p> *@
@*                                     </div> *@
@*                                 </div> *@
@*                 <div class="row"> *@
@*                     <div class="col-md-6"> *@
@*                         <label>Total active lectures :</label> *@
@*                     </div> *@
@*                 </div> *@
@*             </div> *@
@* *@
@*         $1$ <MudGrid> #1# *@
@*         $1$     <MudItem xs="12" sm="7"> #1# *@
@*         $1$         <MudCard> #1# *@
@*         $1$             <MudCardContent> #1# *@
@*         $1$                 <MudList> #1# *@
@*         $1$                      #1# *@
@*         $1$                 </MudList> #1# *@
@*         $1$             </MudCardContent> #1# *@
@*         $1$              #1# *@
@*         $1$         </MudCard> #1# *@
@*         $1$     </MudItem> #1# *@
@*         $1$     <MudItem xs="12" sm="5"> #1# *@
@*         $1$         <MudPaper Class="pa-4 mud-height-full"> #1# *@
@*         $1$            <MudImage ></MudImage> #1# *@
@*         $1$         </MudPaper> #1# *@
@*         $1$     </MudItem> #1# *@
@*         $1$ </MudGrid> #1# *@
@*         <br/> *@

@*         </div> *@
@*     </form> *@
@* </div> *@
@* @if (!(string.IsNullOrEmpty(_errorLabel))) { *@
@*     <Modal> *@
@*         <p> @_errorLabel</p> *@
@*         <button @onclick="Proceed"> Okay</button> *@
@*     </Modal> *@
@* } *@

<AuthorizeView>
    <NotAuthorized>
        <div class="d-flex align-center justify-center">
            <h3>Please log in to view your user profile</h3>
        </div>
        <div>
            <MudCardActions Class="d-flex justify-center">
                               <MudButton Class="mx-2" OnClick="() => OpenLoginView()" Variant="Variant.Filled" Color="Color.Success"><img src="img/Login.png"/></MudButton>
                           </MudCardActions>
        </div>
        
    </NotAuthorized>
    <Authorized Context="Auth">


        <div class="page-background-class align-center justify-center">
             <MudCard Class="mx-auto pa-6 mt-12" Style="width: 500px;">
                <h3 class=" d-flex justify-center">Hello, @CurrentUser?.Name</h3>
                 <div class="form-group d-flex justify-center">
                     <label>User Id : @CurrentUser?.UserId</label>
                 </div>
                 <div class="form-group d-flex justify-center">
                                      <label>Username : @CurrentUser?.Username</label>
                                  </div>
                 <div class="form-group d-flex justify-center">
                     <label>Current email : @CurrentUser?.Email</label>
                 </div>
                 <div class="form-group d-flex justify-center">
                     <label> Role : @CurrentUser?.Role</label>
                 </div>
                       <MudImage Class="card-img" Src="@CurrentUser.Image" ObjectFit="ObjectFit.Contain" Height="200"></MudImage>

                                  
                 <div class="form-control-file">
                                 <label for="image">Image</label>
                                 <InputFile OnChange="OnFileChange"></InputFile>
                             </div>

             </MudCard>
        </div>
            <br/>

            <hr/>
            <br/>
            <br/>
            <div class="page-background-class align-center justify-center">
            <div class="allLectures"><h2>All Lectures</h2>
                @if (_lectureToShow == null) {
                    <LoadingComponent message=" Lectures. Please wait.."></LoadingComponent>
                }
                else {
                    <LectureList lectureToShow="_lecturesToShow"/>
                }

            </div>
            <div class="allLectures"><h2>Upvoted Lectures</h2>
                @if (_upvotedLectureToShow== null) {
                    <LoadingComponent message=" Upvoted lectures. Please wait.."></LoadingComponent>
                }
                else {
                    <LectureList upvotedLectureToShow="_upvotedLectureToShow"/>
                }
            
            </div>
              <div class="allQuestions"> <h2>All Questions</h2> 
                                        @if (_questionToShow == null) {
                                            <LoadingComponent message=" Questions. Please wait.."></LoadingComponent>
                                        }
                                        else {
                                            <QuestionList questionToShow="_questionToShow"/>
                                        }
              </div>
</div>
    </Authorized>

</AuthorizeView>

@code {

    [CascadingParameter]
    public Task<AuthenticationState> AuthState { get; set; } = null!;
    private IEnumerable<Claim>? userClaims;
    private string? username;
    private bool isLoggedIn;
    private List<LectureDto?> _lectureToShow;
    private List<LectureDto?> _upvotedLectureToShow;
    private List<QuestionDto?> _questionToShow;
    private UserCreationDto _newUser = new();

    public UserDto? CurrentUser;

    private void OpenLoginView()
    {
        NavMgr.NavigateTo($"/LoginUI");
    }

    protected override async Task OnInitializedAsync()
    {
        AuthenticationState authState = await AuthState;
        ClaimsPrincipal user = authState.User;
        isLoggedIn = user.Identity != null;
        if (!isLoggedIn) return;
        userClaims = user.Claims;
        username = user.Identity!.Name;
        CurrentUser = await _userService.GetUserByUsernameAsync(username);
        try {
            await GetLecureByUserId();
            await GetUpvotedLecureByUserId();
            await GetQuestionByUserId();
        }
        catch (Exception e) {
            Console.WriteLine(e.Message);
        }
        
    }

  
    async Task OnFileChange(InputFileChangeEventArgs e)
    {
        var format = "image/png";
        var resizedImage = await e.File.RequestImageFileAsync(format, 500, 500);
        var buffer = new byte[resizedImage.Size];
        await resizedImage.OpenReadStream().ReadAsync(buffer);
        var imageData = $"data:{format};base64,{Convert.ToBase64String(buffer)}";
        
        _newUser.Image = imageData;
        
    }
   




    private async Task GetLecureByUserId() {
        _lectureToShow = await _lectureService.GetLectureByUserIdAsync(CurrentUser.UserId);
    }

    private async Task GetUpvotedLecureByUserId() {
        _upvotedLectureToShow = await _lectureService.GetUpvotedLectureByUserIdAsync(CurrentUser.UserId);
    }
    private async Task GetQuestionByUserId() {
        _questionToShow = await _questionService.GetQuestionByUserIdAsync(CurrentUser.UserId);
    }

}
@* @code { *@
@*     [Parameter] *@
@*     public UserDto User { get; set; } *@
@* *@
@*     private LectureDto? _lectureToShow; *@
@*     private int _totalNumberOfLectures; *@
@*     private string? _errorLabel; *@
@*     private bool _showBlockModal; *@
@* *@
@*     private Block _block; *@
@*     private object _navigationManager; *@
@* *@
@* *@

@*     } *@



